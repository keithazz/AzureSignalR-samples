<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/site.css" rel="stylesheet" />
    <title>Infotopia Chat Demo</title>
</head>

<body>
    <h2 class="text-center" style="margin-top: 0; padding-top: 30px;">
        Infotopia Chat Demo
    </h2>
    <div style="height: 100px; width: 60%; margin-left: 20%; display: flex; justify-content: space-evenly;">
        <div style="width: 200px; display: flex; justify-content: center; align-items: center;">
            <button style="width: 150px; height: 40px;" id="newPrivateChat">New Private Chat</button>
        </div>

        <div style="width: 200px; display: flex; justify-content: center; align-items: center;">
            <button style="width: 150px; height: 40px;" id="newGroupChat">New Group Chat</button>
        </div>
    </div>
    <table style="height: calc(100% - 200px); width: 60%; margin-left: 20%; 
    table-layout:fixed">
        <tr>
            <td style="width: 20%;height: 100%;">
                <div style="height: 40px; background-color:#eee;">
                    <div id="userId"
                        style="font-size: 24px; width: 100%; padding: 5px 10px; border-style: hidden;height: 100%;
                    border:1px solid #ccc; border-bottom-style: hidden;border-right-style: hidden; font-size: 20px; text-align: center">
                    </div>
                </div>
                <div style="height: 40px; background-color:#eee;">
                    <div id="tenantId"
                        style="font-size: 24px; width: 100%; padding: 5px 10px; border-style: hidden;height: 100%;
                    border:1px solid #ccc; border-bottom-style: hidden;border-right-style: hidden; font-size: 20px; text-align: center">
                    </div>
                </div>
                <div style="height:calc(100% - 80px);">
                    <div id="roomList" style="border-right-style: hidden">
                    </div>
                </div>
            </td>
            <td>
                <div id="roomLabel" class="roomlabel" style="height: 80px; text-align: center;">Select a Room</div>
                <div style="height:calc(100% - 80px);">
                    <div id="messages" style="background-color: whitesmoke;"></div>
                    <div style="width: 100%; border-left:1px solid #ccc; border-right:1px solid #ccc;">
                        <textarea id="message" style="width: 100%; padding: 5px 10px; border-style: hidden;"
                            placeholder="Type message and press Enter to send..."></textarea>
                    </div>
                    <div style="overflow: auto; border: 1px solid #ccc; border-top-style: hidden;">
                        <button class="btn-success pull-right" id="sendmessage">Send</button>
                    </div>
                </div>
            </td>
        </tr>
    </table>
    <div class="modal alert alert-danger fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div>Connection Error...</div>
                    <div><strong style="font-size: 1.5em;">Hit Refresh/F5</strong> to rejoin. ;)</div>
                </div>
            </div>
        </div>
    </div>

    <!--Reference the SignalR library. -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.1.0/dist/browser/signalr.min.js">
    </script>

    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {

            let tenantId = "default";
            let userId = Math.random().toString(36).substring(2, 10);
            let roomMap = new Map([
                ['Public', 'Public']
            ]);
            let currentRoom = '';
            let currentUser = '';
            let currentTenant = '';
            //the list of users with statuses;
            var userList = [];

            const generateGuid = function () {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    const r = Math.random() * 16 | 0,
                        v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            //  Html encode message.
            const encodedMessage = function (message) {
                return message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }


            //  ask the user to "log in" using a user and tenant ID
            let promptMessage = 'Enter your user ID:';
            do {
                userId = prompt(promptMessage, userId);
                if (!userId || userId.startsWith('_') || userId.indexOf('<') > -1 || userId.indexOf(
                    '>') > -1) {
                    userId = '';
                    promptMessage = 'Invalid input. Enter your ID:';
                }
            } while (!userId);

            promptMessage = 'Enter your tenant ID';
            do {
                tenantId = prompt(promptMessage, tenantId);
                if (!tenantId || tenantId.startsWith('_') || tenantId.indexOf('<') > -1 || tenantId.indexOf(
                    '>') > -1) {
                    tenantId = '';
                    promptMessage = 'Invalid input. Enter your tenant ID:';
                }
            } while (!tenantId);

            document.getElementById('userId').innerText = userId;
            document.getElementById('tenantId').innerText = tenantId;
            currentUser = userId;
            currentTenant = tenantId;
            //TODO make a call to the UpdateLoginInfo hub method

            //  Set initial focus to message input box.
            const messageInput = document.getElementById('message');
            messageInput.focus();

            //NOTE additional setup steps in onConnected function

            // function to switch to a particular room
            const switchToRoom = async function (connection, roomId) {
                //TODO 1. get the list of messages for the chat from the hub
                //TODO 2. add the messages to the messages div
                //TODO 3. mark the last message in the room as read
                //TODO 4. if room is a group, show buttons to add/remove a new user
                //TODO 5. update "currentRoom"
            }
            
            // function to send messages
            const sendUserMessage = async function (connection) {
                console.log(`sendUserMessage: called`);
                //don't do anything if the text box is empty
                if (!messageInput.value) {
                    return;
                }

                //fetch the message text (and reset the text box)
                const messageText = messageInput.value;
                messageInput.value = '';

                //TODO do we need to manually add the outgoing message to the UI?

                //send the message via the hub function
                console.log(`sendUserMessage: ${currentUser} to ${currentRoom}:`);
                console.log(`sendUserMessage: \t\t${messageText}`);
                await connection.invoke('sendTextMessageAsync', currentRoom, currentUser, messageText);
                console.log(`sendUserMessage: done`);
            }

            //WIP add a function which listens for clicks on the "New Group Chat" button
            //TODO swtich from free text to a selector
            const createGroupChat = function () {
                console.log(`createGroupChat: called`);
                //     1. get the group chat name
                let chatName = "";
                promptMessage = "Enter the group chat name:";
                do {
                    chatName = prompt(promptMessage, chatName);
                    if (!chatName || chatName.startsWith('_') || chatName.indexOf('<') > -1 || chatName.indexOf(
                        '>') > -1) {
                        chatName = '';
                        promptMessage = 'Invalid input. Enter your ID:';
                    }
                } while (!chatName);

                //     2. get the member list (assuming the current user will be the only admin)
                let memberList = [];
                let tempUserId = "";
                promptMessage = "Enter the first member's ID:";
                while(true) {
                    tempUserId = prompt(promptMessage, tempUserId);
                    if (!tempUserId) {
                        break;
                    }
                    else if (tempUserId.startsWith('_') || tempUserId.indexOf('<') > -1 || tempUserId.indexOf(
                        '>') > -1) {
                        tempUserId = '';
                        promptMessage = 'Invalid input. Enter a valid user ID:';
                    }
                    else {
                        memberList.push(tempUserId)
                        tempUserId = '';
                        promptMessage = 'User Added. Enter another user ID or leave empty to stop:';
                    }
                }
                console.log(`creating private chat ${chatName} with admin ${userId} and members: ${memberList}`);

                //     2. create the group chat via the hub
                //TODO

                console.log(`createGroupChat: done`);
            }

            //WIP add a function which listens for clicks on the "New Private Chat" button
            //TODO switch from free text to a selector
            const createPrivateChat = async function () {

                //     1. show a dialog box to get the required info
                let otherUserId = "";
                promptMessage = "Enter the other user's ID:";
                do {
                    otherUserId = prompt(promptMessage, otherUserId);
                    if (!otherUserId || otherUserId.startsWith('_') || otherUserId.indexOf('<') > -1 || otherUserId.indexOf(
                        '>') > -1) {
                        otherUserId = '';
                        promptMessage = 'Invalid input. Enter your ID:';
                    }
                } while (!otherUserId);
                console.log(`creating private chat with ${otherUserId}`);

                //     2. create the group chat via the hub
                //TODO make use of the room ID?
                const roomId = await connection.invoke('createPrivateChatAsync', currentUser, otherUserId);

            }


            //TODO add a function which listens for clicks on the "Add User" button
            //     1. show a prompt box to get the user ID
            //     2. add to group chat via the hub

            //TODO add a function which listens for clicks on the "Remove User" button
            //     1. show a prompt box to get the user ID
            //     2. remove from group chat via the hub

            //TODO event handler for NewMessage events
            const handleNewMessageEvent = function (messageObj) {
                console.log(`handleNewMessage: called`);
                console.log(`handleNewMessage: messageObj: ${messageObj.toString()}`);
                console.log(`handleNewMessage: done`);
            }

            //TODO event handler for NewRoom events
            const handleNewRoomEvent = function (senderId, roomId, roomType) {
                console.log(`handleNewRoom: called`);
                console.log(`handleNewRoom: senderId=${senderId}, roomId=${roomId}, roomType=${roomType}`);
                console.log(`handleNewRoom: done`);
            }

            //TODO event handler for NewReadReceipt events
            const handleNewReadReceiptEvent = function (senderId, roomId, sequenceId) {
                console.log(`handleNewReadReceipt: called`);
                console.log(`handleNewReadReceipt: senderId=${senderId}, roomId=${roomId}, sequenceId=${sequenceId}`);
                console.log(`handleNewReadReceipt: done`);
            }

            //TODO event handler for NewStatusUpdate events
            const handleNewStatusUpdateEvent = function (senderId, status) {
                console.log(`handleNewStatusUpdate: senderId=${senderId}, status=${status}`);
                //update the status in the userList
                //TODO a bit dirty since we're leaving the connectionId as is, but it's not used
                const idx = userList.findIndex((obj) => obj.userId == senderId);
                if (idx>-1) {
                    userList[idx].userStatus = status;
                }
                else {
                    //TODO just remove all references to connectionId in here
                    userList.push({userId: senderId, userStatus: status, connectionId: ''})
                }
            }

            //master function which binds incoming events to their respective listeners
            const bindConnectionMessage = function (connection) {

                //  Create a function that the hub can call to broadcast messages.
                connection.on('NewMessage', handleNewMessageEvent);
                connection.on('NewRoom', handleNewRoomEvent);
                connection.on('NewReadReceipt', handleNewReadReceiptEvent);
                connection.on('NewStatusUpdate', handleNewStatusUpdateEvent);
                connection.onclose(onConnectionError);
            }

            //handles setup steps upon connecting to SignalR, and adds various listeners for document elements
            async function onConnected(connection) {
                userList = await connection.invoke('getUsersWithStatusesAsync');
                console.log(userList);

                //TODO fetch user's room previews
                //TODO populate the roomList div
                //TODO      compute which chats have unread messages
                //TODO      combine with user status data (for private chats)
                //TODO auto-select the very first room?

                //add listeners for message sending functionality
                //trigger the function whenever the "Send" button is pressed
                document.getElementById('sendmessage').addEventListener('click', (event) => sendUserMessage(connection));
                //trigger the function whenever the user is typing and presses Enter
                document.getElementById('message').addEventListener('keypress', function (event) {
                        if (event.keyCode === 13) {
                            event.preventDefault();
                            document.getElementById('sendmessage').click();
                            return false;
                        }
                    });

                // TODO add listeners for room switching functionality
                // (call switchToRoom when one of the roomList items is clicked)

                //listeners for room creation functionality
                document.getElementById('newGroupChat').addEventListener('click', (event) => createGroupChat());
                document.getElementById('newPrivateChat').addEventListener('click', (event) => createPrivateChat());

                //TODO add listeners for adding & removing group chat users
            }

            function onConnectionError(error) {
                if (error && error.message) {
                    console.error(error.message);
                }

                const modal = document.getElementById('myModal');
                modal.classList.add('in');
                modal.style = 'display: block;';
            }

            const connection = new signalR.HubConnectionBuilder()
                .withUrl(`/chat?username=${currentUser}-${currentTenant}`)
                .build();

            bindConnectionMessage(connection);
            connection.start()
                .then(function () {
                    onConnected(connection);
                })
                .catch(function (error) {
                    console.error(error.message);
                });

        });
    </script>
</body>

</html>