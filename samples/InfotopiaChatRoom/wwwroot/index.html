<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/site.css" rel="stylesheet" />
    <title>Infotopia Chat Demo</title>
</head>

<body>
    <h2 class="text-center" style="margin-top: 0; padding-top: 30px; padding-bottom: 30px;">
        Infotopia Chat Demo
    </h2>
    <table style="height: calc(100% - 200px); width: 60%; margin-left: 20%; 
    table-layout:fixed">
        <tr>
            <td style="width: 20%;height: 100%;">
                <div style="height: 40px; background-color:#eee;">
                    <div id="userId"
                        style="font-size: 24px; width: 100%; padding: 5px 10px; border-style: hidden;height: 100%;
                    border:1px solid #ccc; border-bottom-style: hidden;border-right-style: hidden; font-size: 20px; text-align: center">
                    </div>
                </div>
                <div style="height: 40px; background-color:#eee;">
                    <div id="tenantId"
                        style="font-size: 24px; width: 100%; padding: 5px 10px; border-style: hidden;height: 100%;
                    border:1px solid #ccc; border-bottom-style: hidden;border-right-style: hidden; font-size: 20px; text-align: center">
                    </div>
                </div>
                <div style="height:calc(100% - 80px);">
                    <div id="roomList" style="border-right-style: hidden">
                    </div>
                </div>
            </td>
            <td>
                <div id="roomLabel" class="roomlabel" style="height: 80px">Select a Room</div>
                <div style="height:calc(100% - 80px);">
                    <div id="messages" style="background-color: whitesmoke;"></div>
                    <div style="width: 100%; border-left:1px solid #ccc; border-right:1px solid #ccc;">
                        <textarea id="message" style="width: 100%; padding: 5px 10px; border-style: hidden;"
                            placeholder="Type message and press Enter to send..."></textarea>
                    </div>
                    <div style="overflow: auto; border: 1px solid #ccc; border-top-style: hidden;">
                        <button class="btn-success pull-right" id="sendmessage">Send</button>
                    </div>
                </div>
            </td>
        </tr>
    </table>
    <div class="modal alert alert-danger fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div>Connection Error...</div>
                    <div><strong style="font-size: 1.5em;">Hit Refresh/F5</strong> to rejoin. ;)</div>
                </div>
            </div>
        </div>
    </div>

    <!--Reference the SignalR library. -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.1.0/dist/browser/signalr.min.js">
    </script>

    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {

            let tenantId = "default";
            let userId = Math.random().toString(36).substring(2, 10);
            let roomMap = new Map([
                ['Public', 'Public']
            ]);
            let currentRoom = 'Public';
            let currentUser = 'Public';

            const generateGuid = function () {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    const r = Math.random() * 16 | 0,
                        v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            //  Html encode message.
            const encodedMessage = function (message) {
                return message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }


            //  ask the user to "log in" using a user and tenant ID
            let promptMessage = 'Enter your user ID:';
            do {
                userId = prompt(promptMessage, userId);
                if (!userId || userId.startsWith('_') || userId.indexOf('<') > -1 || userId.indexOf(
                    '>') > -1 || userId === 'Public') {
                    userId = '';
                    promptMessage = 'Invalid input. Enter your name:';
                }
            } while (!userId);

            promptMessage = 'Enter your tenant ID';
            do {
                tenantId = prompt(promptMessage, tenantId);
                if (!tenantId || tenantId.startsWith('_') || tenantId.indexOf('<') > -1 || tenantId.indexOf(
                    '>') > -1 || tenantId === 'Public') {
                    tenantId = '';
                    promptMessage = 'Invalid input. Enter your name:';
                }
            } while (!tenantId);

            document.getElementById('userId').innerText = userId;
            document.getElementById('tenantId').innerText = tenantId;

            //TODO make a call to the UpdateLoginInfo hub method

            //  Set initial focus to message input box.
            const messageInput = document.getElementById('message');
            messageInput.focus();

            //TODO fetch the list of users & statuses
            //TODO fetch user's room previews
            //TODO populate the roomList div
            //TODO      compute which chats have unread messages
            //TODO      combine with user status data (for private chats)
            //TODO auto-select the very first room?


            //TODO add a function which listens for clicks on the room list
            //when a user chooses a room:
            //     1. get the list of messages for the chat from the hub
            //     2. add the messages to the messages div
            //     3. mark the last message in the room as read
            //     4. if room is a group, show buttons to add/remove a new user

            //TODO add a function to send messages
            //when a user wants to send a message:
            //     1. grab the text & room info
            //     2. send it via the hub
            //     (do we need to update the UI, or will we get a hub message?)
            //TODO trigger the function whenever the "Send" button is pressed
            //TODO trigger the function whenever the user is typing and presses Enter


            //TODO add a function which listens for clicks on the "New Group Chat" button
            //     1. show a dialog box to get the required info
            //     2. create the group chat via the hub

            //TODO add a function which listens for clicks on the "New Private Chat" button
            //     1. show a dialog box to get the required info
            //     2. create the group chat via the hub

            //TODO add a function which listens for clicks on the "Add User" button
            //     1. show a prompt box to get the user ID
            //     2. add to group chat via the hub

            //TODO add a function which listens for clicks on the "Remove User" button
            //     1. show a prompt box to get the user ID
            //     2. remove from group chat via the hub

            //TODO add a listener for NewMessage events

            //TODO add a listener for NewRoom events

            //TODO add a listener for NewReadReceipt events

            //TODO add a listener for NewStatusUpdate events

        });
    </script>
</body>

</html>